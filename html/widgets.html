<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.8" />
<title></title>
<link rel="stylesheet" href="/static/asciidoc.css" type="text/css" />
<link rel="stylesheet" href="/static/layout.css" type="text/css" />
<script type="text/javascript" src="/static/asciidoc.js"></script>
<script type="text/javascript">
/*<![CDATA[*/
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body>
<div id="layout-banner">
  <div id="layout-logo">
    <div id="logo-image"></div>
    <div id="logo-title">Yesod Book中文翻译</div>
  </div>
  <div id="logo-description">Yesod是一个Haskell写的web框架，用于开发类型安全、RESTful、高性能的web应用</div>
</div>
<div id="layout-menu-box">
<div id="layout-menu">
  <div><a href="http://www.yesodweb.com/book">Yesod原版书</a></div>
  <div><a href="index.html">中文版目录</a></div>
  <div id="seperator"></div>
  <div><a href="/html/introduction.html">引言</a></div>
  <div><a href="/html/haskell.html">Haskell</a></div>
  <div><a href="/html/basics.html">基础</a></div>
  <div><a href="/html/shakespearean-templates.html">莎氏模板</a></div>
  <div><a href="/html/widgets.html">控件</a></div>
  <div><a href="/html/yesod-typeclass.html">Yesod型类</a></div>
  <div><a href="/html/routing-and-handlers.html">路由和处理函数</a></div>
  <div><a href="/html/forms.html">表单</a></div>
  <div><a href="/html/sessions.html">会话</a></div>
  <div><a href="/html/persistent.html">Persistent</a></div>
  <div><a href="/html/deploying-your-webapp.html">部署你的web应用</a></div>
  <div id="seperator"></div>
  <div id="repo-link"><a href="https://github.com/rnons/yesodbook-zh"><img src="https://github.com/favicon.ico"/></a></div>
</div>
</div>
<div id="layout-content-box">
<div id="layout-content">
<div id="header">
<div id="toc">
  <div id="toctitle">本章目录</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_控件_widgets">控件 (Widgets)</h2>
<div class="sectionbody">
<div class="paragraph"><p>Web开发的一个挑战是我们要整合三种不同的客户端技术：HTML、CSS和Javascript。更糟
的是，我们必须把它们放在页面的不同位置：CSS要放在头部的style标签内，Javascript
要放在头部的script标签里，HTML要放在正文里。如果你想把CSS和Javascript放在外部
文件中，也完全没有问题！</p></div>
<div class="paragraph"><p>在实践中，这种做法在构建单个网页时能很好工作，因为我们可以将结构(HTML)、样式
(CSS)和逻辑(Javascript)相互分离。但如果我们想构建容易组合的代码模块，要协调这
三个分离的部分就会有点头疼。控件是Yesod对这一问题的解决方法。控件也能帮助避免
重复引用类库，如jQuery。</p></div>
<div class="paragraph"><p>我们的四门模板语言——Hamlet、Cassius、Lucius和Julius——提供了构建输出的原始工具
。控件是让它们完美结合在一起的黏合剂。</p></div>
<div class="sect2">
<h3 id="_概要">概要</h3>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">{-# LANGUAGE QuasiQuotes       #-}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">{-# LANGUAGE TemplateHaskell   #-}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">{-# LANGUAGE TypeFamilies      #-}</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">import</span></span>           <span style="color: #009900">Yesod</span>

<span style="font-weight: bold"><span style="color: #0000FF">data</span></span> <span style="color: #009900">App</span> <span style="color: #990000">=</span> <span style="color: #009900">App</span>
mkYesod <span style="color: #FF0000">"App"</span> <span style="color: #990000">[</span>parseRoutes<span style="color: #990000">|</span>
<span style="color: #990000">/</span> <span style="color: #009900">HomeR</span> <span style="color: #009900">GET</span>
<span style="color: #990000">|]</span>
<span style="font-weight: bold"><span style="color: #0000FF">instance</span></span> <span style="color: #009900">Yesod</span> <span style="color: #009900">App</span>

getHomeR <span style="color: #990000">=</span> defaultLayout <span style="color: #990000">$</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    setTitle <span style="color: #FF0000">"My Page Title"</span>
    toWidget <span style="color: #990000">[</span>lucius<span style="color: #990000">|</span> h1 <span style="color: #990000">{</span> color<span style="color: #990000">:</span> green<span style="color: #990000">;</span> <span style="color: #990000">}</span> <span style="color: #990000">|]</span>
    addScriptRemote <span style="color: #FF0000">"https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"</span>
    toWidget
        <span style="color: #990000">[</span>julius<span style="color: #990000">|</span>
            <span style="color: #990000">$(</span>function<span style="color: #990000">()</span> <span style="color: #990000">{</span>
                <span style="color: #990000">$(</span><span style="color: #FF0000">"h1"</span><span style="color: #990000">).</span>click<span style="color: #990000">(</span>function<span style="color: #990000">(){</span>
                    alert<span style="color: #990000">(</span><span style="color: #FF0000">"You clicked on the heading!"</span><span style="color: #990000">);</span>
                <span style="color: #990000">});</span>
            <span style="color: #990000">});</span>
        <span style="color: #990000">|]</span>
    toWidgetHead
        <span style="color: #990000">[</span>hamlet<span style="color: #990000">|</span>
            <span style="color: #990000">&lt;</span>meta name<span style="color: #990000">=</span>keywords content<span style="color: #990000">=</span><span style="color: #FF0000">"some sample keywords"</span><span style="color: #990000">&gt;</span>
        <span style="color: #990000">|]</span>
    toWidget
        <span style="color: #990000">[</span>hamlet<span style="color: #990000">|</span>
            <span style="color: #990000">&lt;</span>h1<span style="color: #990000">&gt;</span><span style="color: #009900">Here's</span> one way <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> including content
        <span style="color: #990000">|]</span>
    <span style="color: #990000">[</span>whamlet<span style="color: #990000">|&lt;</span>h2<span style="color: #990000">&gt;</span><span style="color: #009900">Here's</span> another <span style="color: #990000">|]</span>
    toWidgetBody
        <span style="color: #990000">[</span>julius<span style="color: #990000">|</span>
            alert<span style="color: #990000">(</span><span style="color: #FF0000">"This is included in the body itself"</span><span style="color: #990000">);</span>
        <span style="color: #990000">|]</span>

main <span style="color: #990000">=</span> warp <span style="color: #993399">3000</span> <span style="color: #009900">App</span></tt></pre></div></div>
<div class="paragraph"><p>这会生成如下的HTML代码(缩进是我增加的)：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">html</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>My Page Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"keywords"</span> <span style="color: #009900">content</span><span style="color: #990000">=</span><span style="color: #FF0000">"some sample keywords"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;style&gt;</span></span>h1<span style="color: #FF0000">{</span><span style="color: #0000FF">color:</span><span style="font-style: italic"><span style="color: #009900">green</span></span><span style="color: #FF0000">}</span><span style="font-weight: bold"><span style="color: #0000FF">&lt;/style&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Here's one way of including content<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>Here's another<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;script&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"This is included in the body itself"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;&lt;script&gt;</span></span>
      $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        $<span style="color: #990000">(</span><span style="color: #FF0000">'h1'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">click</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
          <span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"You clicked on the heading!"</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_控件由哪些元素构成">控件由哪些元素构成？</h3>
<div class="paragraph"><p>从非常浅的层面来说，一个HTML文档不过是一丢嵌套的标签。大部分HTML生成工具都是这
样做的：你定义好标签的层级就可以了。但假设我需要给一个页面写一个组件用来显示导
航栏。我希望它可以“即插即用”：我在适当的时候调用这个函数，导航栏就会被插入到正
确的位置(标签层级)。</p></div>
<div class="paragraph"><p>这是我们简陋的HTML生成工具失效的地方。我们的导航栏除了HTML，可能还包含了一些
CSS和JavaScript。当我们调用导航栏函数时，<span class="monospaced">&lt;head&gt;</span>标签已经生成过了，因此要将包
含(导航栏)CSS的<span class="monospaced">&lt;style&gt;</span>标签加进去已经太迟了。通常的办法是，我们需要将导航栏函
数分为三部分：HTML、CSS和JavaScript，并确保我们总是同时调用这三部分。</p></div>
<div class="paragraph"><p>控件采取的是另一种做法。不把HTML文档视为一个单一的标签树，而是视为许多不同的页
面组件。特别是：</p></div>
<div class="ulist"><ul>
<li>
<p>
标题
</p>
</li>
<li>
<p>
外部CSS
</p>
</li>
<li>
<p>
外部Javascript
</p>
</li>
<li>
<p>
CSS声明
</p>
</li>
<li>
<p>
Javascript代码
</p>
</li>
<li>
<p>
任意的<span class="monospaced">&lt;head&gt;</span>内容
</p>
</li>
<li>
<p>
任意的<span class="monospaced">&lt;body&gt;</span>内容
</p>
</li>
</ul></div>
<div class="paragraph"><p>不同的组件有不同的语义。比如，只能有一个标题，但可以有多个外部脚本和样式表。然
而，每个外部脚本或样式表应该只被引用一次。另一方面，任意的head和body内容是没有
限制的(有些人可能只想放五段lorem ipsum而已)。</p></div>
<div class="paragraph"><p>控件的任务是保持各个组件的相互独立，同时用适当的逻辑将它们组合在一起。这包括：
取第一个标题而忽略其它标题，过滤重复的外部脚本和样式表引用，拼接head和body的内
容，等等。</p></div>
</div>
<div class="sect2">
<h3 id="_构造控件">构造控件</h3>
<div class="paragraph"><p>为了使用控件，你当然需要能够构造他们。最常用的方法是通过<span class="monospaced">ToWidget</span>型类，以及它
的<span class="monospaced">toWidget</span>方法。它能把你的莎氏模板直接转换成<span class="monospaced">Widget</span>：Hamlet代码会出现在正文
，Julius脚本会在头部的<span class="monospaced">&lt;script&gt;</span>标签里，Cassius和Lucius会在(头部的)<span class="monospaced">&lt;style&gt;</span>标
签里。</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">你实际上可以覆盖默认行为，让脚本和样式代码出现在各自的外部文件里。脚手架
项目自动为你完成这一点。</td>
</tr></table>
</div>
<div class="paragraph"><p>但如果你想增加一些<span class="monospaced">&lt;meta&gt;</span>标签呢？它们也需要放在头部。或者如果你想让Javascript
出现在正文而不是头部呢？为此，Yesod提供了另外两个型类：<span class="monospaced">ToWidgetHead</span>和
<span class="monospaced">ToWidgetBody</span>。这两个类(的作用)就像它们名字说的一样。</p></div>
<div class="paragraph"><p>另外，还有一些其它函数用来创建特殊的控件：</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
setTitle
</dt>
<dd>
<p>
将一些HTML代码转换成页面标题。
</p>
</dd>
<dt class="hdlist1">
toWidgetMedia
</dt>
<dd>
<p>
与toWidget一样，但需要一个额外的参数来表示样
式所应用的媒介。这对于创建比如说打印样式会有用。
</p>
</dd>
<dt class="hdlist1">
addStylesheet
</dt>
<dd>
<p>
通过<span class="monospaced">&lt;link&gt;</span>标签，增加一个外部样式表的引用。输入参数是类型安全
的URL。
</p>
</dd>
<dt class="hdlist1">
addStylesheetRemote
</dt>
<dd>
<p>
与<span class="monospaced">addStylesheet</span>一样，但输入参数是普通URL。对于引用托管
在CDN上的文件有用，比如Google CDN上的jQuery UI CSS文件。
</p>
</dd>
<dt class="hdlist1">
addScript
</dt>
<dd>
<p>
通过<span class="monospaced">&lt;script&gt;</span>标签，增加一个外部脚本的引用。输入参数是类型安全的
URL。
</p>
</dd>
<dt class="hdlist1">
addScriptRemote
</dt>
<dd>
<p>
与<span class="monospaced">addScript</span>一样，但输入参数是普通URL。对于引用托管在CDN上
的文件有用，比如Google CDN上的jQuery文件。
</p>
</dd>
</dl></div>
</div>
<div class="sect2">
<h3 id="_组合控件_combining_widgets">组合控件 (Combining Widgets)</h3>
<div class="paragraph"><p>控件的目的是增强可组合性。你可以将单独的HTML、CSS和Javascript组合成更复杂的结
构，然后再进一步组合成完整的页面。这些都能通过<span class="monospaced">Widget</span>的<span class="monospaced">Monad</span>实例很自然地实
现，也就是说你可以用do语句来组合控件。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>myWidget1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    toWidget <span style="color: #990000">[</span>hamlet<span style="color: #990000">|&lt;</span>h1<span style="color: #990000">&gt;</span><span style="color: #009900">My</span> <span style="color: #009900">Title</span><span style="color: #990000">|]</span>
    toWidget <span style="color: #990000">[</span>lucius<span style="color: #990000">|</span>h1 <span style="color: #990000">{</span> color<span style="color: #990000">:</span> green <span style="color: #990000">}</span> <span style="color: #990000">|]</span>

myWidget2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    setTitle <span style="color: #FF0000">"My Page Title"</span>
    addScriptRemote <span style="color: #FF0000">"http://www.example.com/script.js"</span>

myWidget <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    myWidget1
    myWidget2

<span style="font-style: italic"><span style="color: #9A1900">-- or, if you want</span></span>
myWidget' <span style="color: #990000">=</span> myWidget1 <span style="color: #990000">&gt;&gt;</span> myWidget2</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">如果你需要的话，<span class="monospaced">Widget</span>也是<span class="monospaced">Monoid</span>的实例。也就是说你可以使用<span class="monospaced">mconcat</span>
或<span class="monospaced">Writer</span> monad来组合控件。以我的经验来说，用do语句最简单也最自然。</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_生成id">生成ID</h3>
<div class="paragraph"><p>如果我们要进行真正的代码复用，我们总是会遇到命名冲突。假设我们有两个辅助库都用
了&#8216;`foo&#8217;'这个类名来控制样式。我们想要避免这种情况。因此，我们有<span class="monospaced">newIdent</span>函数
。它会为当前的处理函数自动生成一个唯一的名字。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>getRootR <span style="color: #990000">=</span> defaultLayout <span style="color: #990000">$</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    headerClass <span style="color: #990000">&lt;-</span> newIdent
    toWidget <span style="color: #990000">[</span>hamlet<span style="color: #990000">|&lt;</span>h1 <span style="color: #990000">.#{</span>headerClass<span style="color: #990000">}&gt;</span><span style="color: #009900">My</span> <span style="color: #009900">Header</span><span style="color: #990000">|]</span>
    toWidget <span style="color: #990000">[</span>lucius<span style="color: #990000">|</span> <span style="color: #990000">.#{</span>headerClass<span style="color: #990000">}</span> <span style="color: #990000">{</span> color<span style="color: #990000">:</span> green<span style="color: #990000">;</span> <span style="color: #990000">}</span> <span style="color: #990000">|]</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_whamlet">whamlet</h3>
<div class="paragraph"><p>假设我们有一个标准的Hamlet模板，它嵌套了另一个Hamlet模板来表示页脚：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>page <span style="color: #990000">=</span>
    <span style="color: #990000">[</span>hamlet<span style="color: #990000">|</span>
        <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span><span style="color: #009900">This</span> is my page<span style="color: #990000">.</span> <span style="color: #009900">I</span> hope you enjoyed it<span style="color: #990000">.</span>
        <span style="color: #990000">^{</span>footer<span style="color: #990000">}</span>
    <span style="color: #990000">|]</span>

footer <span style="color: #990000">=</span>
    <span style="color: #990000">[</span>hamlet<span style="color: #990000">|</span>
        <span style="color: #990000">&lt;</span>footer<span style="color: #990000">&gt;</span>
            <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span><span style="color: #009900">That's</span> all folks<span style="color: #990000">!</span>
    <span style="color: #990000">|]</span></tt></pre></div></div>
<div class="paragraph"><p>如果页脚是普通的HTML，它能正常工作，但如果我们想要增加一些样式呢？好吧，我们可
以很容易的将页脚转换成一个控件：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>footer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    toWidget
        <span style="color: #990000">[</span>lucius<span style="color: #990000">|</span>
            footer <span style="color: #990000">{</span>
                font<span style="color: #990000">-</span>weight<span style="color: #990000">:</span> bold<span style="color: #990000">;</span>
                text<span style="color: #990000">-</span>align<span style="color: #990000">:</span> center
            <span style="color: #990000">}</span>
        <span style="color: #990000">|]</span>
    toWidget
        <span style="color: #990000">[</span>hamlet<span style="color: #990000">|</span>
            <span style="color: #990000">&lt;</span>footer<span style="color: #990000">&gt;</span>
                <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span><span style="color: #009900">That's</span> all folks<span style="color: #990000">!</span>
        <span style="color: #990000">|]</span></tt></pre></div></div>
<div class="paragraph"><p>但我们有个问题：一个Hamlet模板只能嵌套另一个Hamlet模板；它不知道什么是控件。这
就是<span class="monospaced">whamlet</span>的用处了。它的语法与普通的Hamlet完全一致，并且变量插值(#{&#8230;})和
URL插值(@{&#8230;})也是一样的。但嵌套插值(<span class="monospaced">^{&#8230;}</span>)的输入参数是一个控件，输出结果
也是一个控件。要使用它，只需要：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>page <span style="color: #990000">=</span>
    <span style="color: #990000">[</span>whamlet<span style="color: #990000">|</span>
        <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span><span style="color: #009900">This</span> is my page<span style="color: #990000">.</span> <span style="color: #009900">I</span> hope you enjoyed it<span style="color: #990000">.</span>
        <span style="color: #990000">^{</span>footer<span style="color: #990000">}</span>
    <span style="color: #990000">|]</span></tt></pre></div></div>
<div class="paragraph"><p>如果你更喜欢把模板放在外部文件里的话，还可以用<span class="monospaced">whamletFile</span>函数。</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">脚手架项目有一个更方便的函数，<span class="monospaced">widgetFile</span>，它会自动引用你的Lucius、
Cassius和Julius文件。我们会在“脚手架”一章中详述。</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_类型">类型</h4>
<div class="paragraph"><p>你可能注意到了我一直在回避控件的类型标识。简单的答案是每个控件的类型都是
<span class="monospaced">Widget</span>。但如果你去Yesod类库里找，却找不到<span class="monospaced">Widget</span>的定义。怎么回事？</p></div>
<div class="paragraph"><p>Yesod定义了一个非常相似的类型：<span class="monospaced">data WidgetT site m a</span>。这个数据类型是一个
*monad transformer*。最后两个参数是底层monad类型和monad值。site是你的应用的基
础数据类型。因为基础数据类型随每个站点而不同，不可能在类库里定义一个适用于所有
应用的<span class="monospaced">Widget</span>数据类型。</p></div>
<div class="paragraph"><p>取而代之，<span class="monospaced">mkYesod</span>这个Haskell模板函数会为你生成类型别名。假设你的基础数据类型
是<span class="monospaced">MyApp</span>，那你的<span class="monospaced">Widget</span>的定义是这样的：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">Widget</span> <span style="color: #990000">=</span> <span style="color: #009900">WidgetT</span> <span style="color: #009900">MyApp</span> <span style="color: #009900">IO</span> <span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>我们将monad的值设为<span class="monospaced">()</span>，因为一个控件的值最终是被丢弃的。<span class="monospaced">IO</span>是标准的基础monad
，几乎在所有情况下都会用到。唯一的例外是写子站(subsite)的时候。子站是一个更高
级的话题，会在它自己的章节中讲解。</p></div>
<div class="paragraph"><p>一旦我们知道了<span class="monospaced">Widget</span>的类型，就很容易给前面的例子加上类型标识：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>footer <span style="color: #990000">::</span> <span style="color: #009900">Widget</span>
footer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    toWidget
        <span style="color: #990000">[</span>lucius<span style="color: #990000">|</span>
            footer <span style="color: #990000">{</span>
                font<span style="color: #990000">-</span>weight<span style="color: #990000">:</span> bold<span style="color: #990000">;</span>
                text<span style="color: #990000">-</span>align<span style="color: #990000">:</span> center
            <span style="color: #990000">}</span>
        <span style="color: #990000">|]</span>
    toWidget
        <span style="color: #990000">[</span>hamlet<span style="color: #990000">|</span>
            <span style="color: #990000">&lt;</span>footer<span style="color: #990000">&gt;</span>
                <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span><span style="color: #009900">That's</span> all folks<span style="color: #990000">!</span>
        <span style="color: #990000">|]</span>

page <span style="color: #990000">::</span> <span style="color: #009900">Widget</span>
page <span style="color: #990000">=</span>
    <span style="color: #990000">[</span>whamlet<span style="color: #990000">|</span>
        <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span><span style="color: #009900">This</span> is my page<span style="color: #990000">.</span> <span style="color: #009900">I</span> hope you enjoyed it<span style="color: #990000">.</span>
        <span style="color: #990000">^{</span>footer<span style="color: #990000">}</span>
    <span style="color: #990000">|]</span></tt></pre></div></div>
<div class="paragraph"><p>等我们开始讲解处理函数时，我们会在<span class="monospaced">HandlerT</span>和<span class="monospaced">Handler</span>类型身上看到相似的情况
。</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_使用控件">使用控件</h3>
<div class="paragraph"><p>我们有这么漂亮的控件数据类型已经很好了，但到底怎么把它们转换成用户可以与之交互
的东西？最常用的做法是<span class="monospaced">defaultLayout</span>函数，它的类型标识是<span class="monospaced">Widget &#8594; Handler
Html</span>。</p></div>
<div class="paragraph"><p><span class="monospaced">defaultLayout</span>实际上是个型类的方法，它可以在每个应用中重新定义。这也是Yesod应
用定义主题的方法。所以我们剩下的问题是：在<span class="monospaced">defaultLayout</span>函数内，怎么拆开一个
<span class="monospaced">Widget</span>？答案是用<span class="monospaced">widgetToPageContent</span>函数。让我们看一下(简化了的)类型：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>widgetToPageContent <span style="color: #990000">::</span> <span style="color: #009900">Widget</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Handler</span> <span style="color: #990000">(</span><span style="color: #009900">PageContent</span> url<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">data</span></span> <span style="color: #009900">PageContent</span> url <span style="color: #990000">=</span> <span style="color: #009900">PageContent</span>
    <span style="color: #990000">{</span> pageTitle <span style="color: #990000">::</span> <span style="color: #009900">Html</span>
    <span style="color: #990000">,</span> pageHead <span style="color: #990000">::</span> <span style="color: #009900">HtmlUrl</span> url
    <span style="color: #990000">,</span> pageBody <span style="color: #990000">::</span> <span style="color: #009900">HtmlUrl</span> url
    <span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>距离我们的目标已经很近了。我们现在可以直接访问HTML的头部和正文，以及标题。至此
，我们可以用Hamlet把它们与页面布局组合成一个文件，然后用<span class="monospaced">giveUrlRenderer</span>函数
将Hamlet的结果转换为实际呈现给用户的HTML。下面的代码说明了这个过程。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">{-# LANGUAGE QuasiQuotes       #-}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">{-# LANGUAGE TemplateHaskell   #-}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">{-# LANGUAGE TypeFamilies      #-}</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">import</span></span>           <span style="color: #009900">Yesod</span>

<span style="font-weight: bold"><span style="color: #0000FF">data</span></span> <span style="color: #009900">App</span> <span style="color: #990000">=</span> <span style="color: #009900">App</span>
mkYesod <span style="color: #FF0000">"App"</span> <span style="color: #990000">[</span>parseRoutes<span style="color: #990000">|</span>
<span style="color: #990000">/</span> <span style="color: #009900">HomeR</span> <span style="color: #009900">GET</span>
<span style="color: #990000">|]</span>

myLayout <span style="color: #990000">::</span> <span style="color: #009900">Widget</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Handler</span> <span style="color: #009900">Html</span>
myLayout widget <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    pc <span style="color: #990000">&lt;-</span> widgetToPageContent widget
    giveUrlRenderer
        <span style="color: #990000">[</span>hamlet<span style="color: #990000">|</span>
            <span style="color: #990000">$</span>doctype <span style="color: #993399">5</span>
            <span style="color: #990000">&lt;</span>html<span style="color: #990000">&gt;</span>
                <span style="color: #990000">&lt;</span>head<span style="color: #990000">&gt;</span>
                    <span style="color: #990000">&lt;</span>title<span style="color: #990000">&gt;#{</span>pageTitle pc<span style="color: #990000">}</span>
                    <span style="color: #990000">&lt;</span>meta charset<span style="color: #990000">=</span>utf<span style="color: #990000">-</span><span style="color: #993399">8</span><span style="color: #990000">&gt;</span>
                    <span style="color: #990000">&lt;</span>style<span style="color: #990000">&gt;</span>body <span style="color: #990000">{</span> font<span style="color: #990000">-</span>family<span style="color: #990000">:</span> verdana <span style="color: #990000">}</span>
                    <span style="color: #990000">^{</span>pageHead pc<span style="color: #990000">}</span>
                <span style="color: #990000">&lt;</span>body<span style="color: #990000">&gt;</span>
                    <span style="color: #990000">&lt;</span>article<span style="color: #990000">&gt;</span>
                        <span style="color: #990000">^{</span>pageBody pc<span style="color: #990000">}</span>
        <span style="color: #990000">|]</span>

<span style="font-weight: bold"><span style="color: #0000FF">instance</span></span> <span style="color: #009900">Yesod</span> <span style="color: #009900">App</span> <span style="font-weight: bold"><span style="color: #0000FF">where</span></span>
    defaultLayout <span style="color: #990000">=</span> myLayout

getHomeR <span style="color: #990000">::</span> <span style="color: #009900">Handler</span> <span style="color: #009900">Html</span>
getHomeR <span style="color: #990000">=</span> defaultLayout
    <span style="color: #990000">[</span>whamlet<span style="color: #990000">|</span>
        <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span><span style="color: #009900">Hello</span> <span style="color: #009900">World</span><span style="color: #990000">!</span>
    <span style="color: #990000">|]</span>

main <span style="color: #990000">::</span> <span style="color: #009900">IO</span> <span style="color: #990000">()</span>
main <span style="color: #990000">=</span> warp <span style="color: #993399">3000</span> <span style="color: #009900">App</span></tt></pre></div></div>
<div class="paragraph"><p>这都很好，但还有一件事困扰我：就是<span class="monospaced">style</span>标签。它有一些问题：</p></div>
<div class="ulist"><ul>
<li>
<p>
不像Lucius和Cassius，它不能在编译时做正确性检查。
</p>
</li>
<li>
<p>
虽然这个例子很简单，但在复杂的情况下，我们会遇到字符转义的问题。
</p>
</li>
<li>
<p>
我们会有两个style标签而不是一个：一个是<span class="monospaced">myLayout</span>生成的，另一个是<span class="monospaced">pageHead</span>
  基于控件内设置的样式生成的。
</p>
</li>
</ul></div>
<div class="paragraph"><p>我们还有一个锦囊可以用：我们在调用<span class="monospaced">widgetToPageContent</span>前对控件做一些最后的调
整。其实非常简单：我们只是再次用了do语句。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">{-# LANGUAGE QuasiQuotes       #-}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">{-# LANGUAGE TemplateHaskell   #-}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">{-# LANGUAGE TypeFamilies      #-}</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">import</span></span>           <span style="color: #009900">Yesod</span>

<span style="font-weight: bold"><span style="color: #0000FF">data</span></span> <span style="color: #009900">App</span> <span style="color: #990000">=</span> <span style="color: #009900">App</span>
mkYesod <span style="color: #FF0000">"App"</span> <span style="color: #990000">[</span>parseRoutes<span style="color: #990000">|</span>
<span style="color: #990000">/</span> <span style="color: #009900">HomeR</span> <span style="color: #009900">GET</span>
<span style="color: #990000">|]</span>

myLayout <span style="color: #990000">::</span> <span style="color: #009900">Widget</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Handler</span> <span style="color: #009900">Html</span>
myLayout widget <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    pc <span style="color: #990000">&lt;-</span> widgetToPageContent <span style="color: #990000">$</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
        widget
        toWidget <span style="color: #990000">[</span>lucius<span style="color: #990000">|</span> body <span style="color: #990000">{</span> font<span style="color: #990000">-</span>family<span style="color: #990000">:</span> verdana <span style="color: #990000">}</span> <span style="color: #990000">|]</span>
    giveUrlRenderer
        <span style="color: #990000">[</span>hamlet<span style="color: #990000">|</span>
            <span style="color: #990000">$</span>doctype <span style="color: #993399">5</span>
            <span style="color: #990000">&lt;</span>html<span style="color: #990000">&gt;</span>
                <span style="color: #990000">&lt;</span>head<span style="color: #990000">&gt;</span>
                    <span style="color: #990000">&lt;</span>title<span style="color: #990000">&gt;#{</span>pageTitle pc<span style="color: #990000">}</span>
                    <span style="color: #990000">&lt;</span>meta charset<span style="color: #990000">=</span>utf<span style="color: #990000">-</span><span style="color: #993399">8</span><span style="color: #990000">&gt;</span>
                    <span style="color: #990000">^{</span>pageHead pc<span style="color: #990000">}</span>
                <span style="color: #990000">&lt;</span>body<span style="color: #990000">&gt;</span>
                    <span style="color: #990000">&lt;</span>article<span style="color: #990000">&gt;</span>
                        <span style="color: #990000">^{</span>pageBody pc<span style="color: #990000">}</span>
        <span style="color: #990000">|]</span>

<span style="font-weight: bold"><span style="color: #0000FF">instance</span></span> <span style="color: #009900">Yesod</span> <span style="color: #009900">App</span> <span style="font-weight: bold"><span style="color: #0000FF">where</span></span>
    defaultLayout <span style="color: #990000">=</span> myLayout

getHomeR <span style="color: #990000">::</span> <span style="color: #009900">Handler</span> <span style="color: #009900">Html</span>
getHomeR <span style="color: #990000">=</span> defaultLayout
    <span style="color: #990000">[</span>whamlet<span style="color: #990000">|</span>
        <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span><span style="color: #009900">Hello</span> <span style="color: #009900">World</span><span style="color: #990000">!</span>
    <span style="color: #990000">|]</span>

main <span style="color: #990000">::</span> <span style="color: #009900">IO</span> <span style="color: #990000">()</span>
main <span style="color: #990000">=</span> warp <span style="color: #993399">3000</span> <span style="color: #009900">App</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_使用处理函数">使用处理函数</h3>
<div class="paragraph"><p>我们至今还没怎么讲处理函数，但一旦开始讲，问题就来了：我们怎么在控件中使用这
些函数？比如，如果一个控件需要使用<span class="monospaced">lookupGetParam</span>来查询请求参数？</p></div>
<div class="paragraph"><p>第一种答案是用<span class="monospaced">handlerToWidget</span>函数，它将一个<span class="monospaced">Handler</span>动作转换为一个<span class="monospaced">Widget</span>。
然而，在很多情况下并不需要这么做。来看看<span class="monospaced">lookupGetParam</span>函数的类型标识：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>lookupGetParam <span style="color: #990000">::</span> <span style="color: #009900">MonadHandler</span> m <span style="color: #990000">=&gt;</span> <span style="color: #009900">Text</span> <span style="color: #990000">-&gt;</span> m <span style="color: #990000">(</span><span style="color: #009900">Maybe</span> <span style="color: #009900">Text</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>这个函数可以在<strong>任何</strong><span class="monospaced">MonadHandler</span>的实例中使用。而且方便的是，<span class="monospaced">Widget</span>就是
<span class="monospaced">MonadHandler</span>的实例。这意味着大部分代码既可以在<span class="monospaced">Handler</span>中运行，也可以在
<span class="monospaced">Widget</span>中运行。而且如果你需要显式的将<span class="monospaced">Handler</span>转换为<span class="monospaced">Widget</span>，你还是可以用
<span class="monospaced">handlerToWidget</span>函数。</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">这与Yesod 1.1及更早的版本有显著的区别。之前是没有<span class="monospaced">MonadHandler</span>这个型类
的，所有函数都需要显式的使用<span class="monospaced">lift</span>转换，而不是<span class="monospaced">handlerToWidget</span>。新版本不仅更
容易使用，而且也避免了旧版中使用的奇怪的monad transformer技巧。</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_小结">小结</h3>
<div class="paragraph"><p>构筑每个页面的砖块是控件。独立的HTML、CSS和Javascript代码段可以通过多态的
<span class="monospaced">toWidget</span>函数转换成控件。使用do语句，可以将这些独立的控件组合成更大的控件，最
后构成页面的全部内容。</p></div>
<div class="paragraph"><p>通常在defaultLayout函数中拆开这些控件，defaulLayout能将统一的外观风格应用到所
有页面。</p></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2014-01-18 22:32:21 CST <br/>
本站全部内容以MIT和Creative Commons 4.0许可证发布。详情请看<a href="https://raw.github.com/rnons/yesodbook-zh/master/LICENSE">许可证文件</a>。
</div>
</div>
</div>
</div>
</body>
</html>
